# Sequence Diagrams

## Booking Flow Sequence Diagram

```
┌─────────┐    ┌──────────┐    ┌──────────┐    ┌─────────────┐    ┌──────────────┐
│ Patient │    │   API    │    │Database  │    │   Redis     │    │Payment Gate │
└────┬────┘    └────┬─────┘    └────┬─────┘    └────┬────────┘    └──────┬───────┘
     │              │                │                │                     │
     │ POST /consultations          │                │                     │
     │────────────────────────────>│                │                     │
     │              │                │                │                     │
     │              │ Validate Request                │                     │
     │              │────────────────┐               │                     │
     │              │<────────────────┘               │                     │
     │              │                │                │                     │
     │              │ Check Doctor Availability       │                     │
     │              │────────────────────────────────>│                     │
     │              │<────────────────────────────────│                     │
     │              │                │                │                     │
     │              │ Check Slot Availability         │                     │
     │              │────────────────────────────────>│                     │
     │              │<────────────────────────────────│                     │
     │              │                │                │                     │
     │              │ BEGIN TRANSACTION              │                     │
     │              │────────────────────────────────>│                     │
     │              │                │                │                     │
     │              │ Check for Conflicts             │                     │
     │              │────────────────────────────────>│                     │
     │              │<────────────────────────────────│                     │
     │              │                │                │                     │
     │              │ Create Consultation              │                     │
     │              │────────────────────────────────>│                     │
     │              │<────────────────────────────────│                     │
     │              │                │                │                     │
     │              │ Create Payment Record            │                     │
     │              │────────────────────────────────>│                     │
     │              │<────────────────────────────────│                     │
     │              │                │                │                     │
     │              │ COMMIT TRANSACTION              │                     │
     │              │────────────────────────────────>│                     │
     │              │<────────────────────────────────│                     │
     │              │                │                │                     │
     │              │ Process Payment                 │                     │
     │              │──────────────────────────────────────────────────────>│
     │              │<──────────────────────────────────────────────────────│
     │              │                │                │                     │
     │              │ Update Payment Status           │                     │
     │              │────────────────────────────────>│                     │
     │              │<────────────────────────────────│                     │
     │              │                │                │                     │
     │              │ Invalidate Cache                │                     │
     │              │────────────────────────────────>│                     │
     │              │<────────────────────────────────│                     │
     │              │                │                │                     │
     │              │ Audit Log                       │                     │
     │              │────────────────────────────────>│                     │
     │              │<────────────────────────────────│                     │
     │              │                │                │                     │
     │<─────────────│                │                │                     │
     │ 201 Created  │                │                │                     │
     │              │                │                │                     │
```

## Authentication Flow Sequence Diagram

```
┌─────────┐    ┌──────────┐    ┌──────────┐    ┌─────────────┐
│  User   │    │   API    │    │Database  │    │   Redis     │
└────┬────┘    └────┬─────┘    └────┬─────┘    └────┬────────┘
     │              │                │                │
     │ POST /auth/login              │                │
     │──────────────────────────────>│                │
     │              │                │                │
     │              │ Validate Input │                │
     │              │────────────────┐               │
     │              │<────────────────┘               │
     │              │                │                │
     │              │ Find User      │                │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ Verify Password                │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ Check MFA Status               │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ IF MFA Enabled:                │
     │              │   Return MFA Required           │
     │<─────────────│────────────────────────────────│
     │ 200 MFA Req  │                │                │
     │              │                │                │
     │ POST /auth/login (with MFA token)             │
     │──────────────────────────────>│                │
     │              │                │                │
     │              │ Verify MFA Token                │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ Generate JWT    │                │
     │              │────────────────┐               │
     │              │<────────────────┘               │
     │              │                │                │
     │              │ Update Last Login               │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ Store Session (optional)        │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ Audit Log      │                │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │<─────────────│                │                │
     │ 200 Success  │                │                │
     │              │                │                │
```

## Consultation Update Flow (Status Change)

```
┌─────────┐    ┌──────────┐    ┌──────────┐    ┌─────────────┐
│  Doctor  │    │   API    │    │Database  │    │   Redis     │
└────┬────┘    └────┬─────┘    └────┬─────┘    └────┬────────┘
     │              │                │                │
     │ PUT /consultations/:id        │                │
     │──────────────────────────────>│                │
     │              │                │                │
     │              │ Authenticate   │                │
     │              │────────────────┐               │
     │              │<────────────────┘               │
     │              │                │                │
     │              │ Authorize      │                │
     │              │────────────────┐               │
     │              │<────────────────┘               │
     │              │                │                │
     │              │ Validate Input │                │
     │              │────────────────┐               │
     │              │<────────────────┘               │
     │              │                │                │
     │              │ Get Consultation                │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ BEGIN TRANSACTION              │
     │              │────────────────────────────────>│
     │              │                │                │
     │              │ Update Consultation             │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ IF status = 'in_progress':      │
     │              │   Update started_at             │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ IF status = 'completed':        │
     │              │   Update ended_at               │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ COMMIT TRANSACTION             │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ Invalidate Cache                │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ Audit Log      │                │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │<─────────────│                │                │
     │ 200 Updated  │                │                │
     │              │                │                │
```

## Prescription Creation Flow

```
┌─────────┐    ┌──────────┐    ┌──────────┐    ┌─────────────┐
│  Doctor │    │   API    │    │Database  │    │   Redis     │
└────┬────┘    └────┬─────┘    └────┬─────┘    └────┬────────┘
     │              │                │                │
     │ POST /prescriptions           │                │
     │──────────────────────────────>│                │
     │              │                │                │
     │              │ Authenticate & Authorize        │
     │              │────────────────┐               │
     │              │<────────────────┘               │
     │              │                │                │
     │              │ Validate Input │                │
     │              │────────────────┐               │
     │              │<────────────────┘               │
     │              │                │                │
     │              │ Get Consultation                │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ Verify Consultation Status      │
     │              │────────────────┐               │
     │              │<────────────────┘               │
     │              │                │                │
     │              │ BEGIN TRANSACTION              │
     │              │────────────────────────────────>│
     │              │                │                │
     │              │ Deactivate Old Prescriptions    │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ Create New Prescription         │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ COMMIT TRANSACTION             │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ Audit Log      │                │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │<─────────────│                │                │
     │ 201 Created  │                │                │
     │              │                │                │
```

## Error Handling Flow

```
┌─────────┐    ┌──────────┐    ┌──────────┐    ┌─────────────┐
│  Client │    │   API    │    │Database  │    │   Logger    │
└────┬────┘    └────┬─────┘    └────┬─────┘    └────┬────────┘
     │              │                │                │
     │ Request      │                │                │
     │──────────────────────────────>│                │
     │              │                │                │
     │              │ Process Request│                │
     │              │────────────────────────────────>│
     │              │                │                │
     │              │<────────────────────────────────│
     │              │   ERROR        │                │
     │              │                │                │
     │              │ Log Error      │                │
     │              │────────────────────────────────────────────────────>│
     │              │                │                │
     │              │ Rollback Transaction (if any)  │
     │              │────────────────────────────────>│
     │              │<────────────────────────────────│
     │              │                │                │
     │              │ Format Error Response           │
     │              │────────────────┐               │
     │              │<────────────────┘               │
     │              │                │                │
     │<─────────────│                │                │
     │ Error Response│                │                │
     │              │                │                │
```


